stages:
  - build
  - deploy

build:
  stage: build
  image: node:20
  tags:
    - trainer
  script:
    - echo "🚀 Starting build process for application..."
    - echo "🔧 Installing required tools..."
    - apt-get update -qq && apt-get install -y -qq zip
    - echo "📦 Installing dependencies with npm ci..."
    - npm ci
    - echo "🔨 Building application..."
    - npm run build
    - echo "📂 Creating deployment package..."
    - cd dist
    - zip -r ../deploy.zip .
    - cd ..
    - echo "✅ Build completed successfully! Deployment package created."
  artifacts:
    paths:
      - deploy.zip
  only:
    - staging

deploy:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  tags:
    - trainer
  script:
    - echo "🌐 Starting deployment to AWS Amplify..."
    - echo "🔑 Configuring AWS credentials..."
    - aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
    - aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
    - echo "⚙️ Configuring AWS region to ap-southeast-1..."
    - aws configure set region ap-southeast-1
    - echo "🔍 Verifying AWS authentication..."
    - aws sts get-caller-identity
    - echo "📤 Deploying application to Amplify..."
    - aws amplify start-deployment --app-id $STAGING_AMPLIFY_APP_ID --branch-name staging --source-url file://deploy.zip
    - echo "🎉 Deployment completed successfully! Your application is now live."
  only:
    - staging
  dependencies:
    - build