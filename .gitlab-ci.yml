stages:
  - build
  - deploy

build:
  stage: build
  image: node:20-bullseye
  tags:
    - trainer
  script:
    - echo "üöÄ Starting build process..."
    - apt-get update -qq && apt-get install -y -qq zip
    
    # T·∫°o file .env t·ª´ bi·∫øn m√¥i tr∆∞·ªùng
    - echo "üîß Configuring environment..."
    - echo "$STAGING_ENV" > .env
    - cat .env
    
    # C√†i ƒë·∫∑t dependencies v√† v√° lightningcss
    - echo "üì¶ Installing dependencies v√† v√° lightningcss..."
    - |
      # T·∫°o .npmrc ƒë·ªÉ b·ªè qua ki·ªÉm tra peer dependencies
      echo "legacy-peer-deps=true" > .npmrc
      
      # C√†i ƒë·∫∑t dependencies
      npm install --force --ignore-scripts
      
      # V√° react-day-picker ƒë·ªÉ ch·∫•p nh·∫≠n React 19
      echo "V√° file node_modules/react-day-picker/package.json"
      node -e "
        const fs = require('fs');
        try {
          const packagePath = './node_modules/react-day-picker/package.json';
          if (fs.existsSync(packagePath)) {
            let pkg = JSON.parse(fs.readFileSync(packagePath, 'utf8'));
            if (pkg.peerDependencies && pkg.peerDependencies.react) {
              pkg.peerDependencies.react = '^16.8.0 || ^17.0.0 || ^18.0.0 || ^19.0.0';
              fs.writeFileSync(packagePath, JSON.stringify(pkg, null, 2));
              console.log('ƒê√£ v√° th√†nh c√¥ng react-day-picker');
            }
          }
        } catch (error) {
          console.error('L·ªói khi v√° file:', error);
        }
      "
      
      # T·∫Øt ho√†n to√†n lightningcss ƒë·ªÉ tr√°nh l·ªói
      echo "T·∫Øt ho√†n to√†n lightningcss..."
      
      # 1. V√¥ hi·ªáu h√≥a th∆∞ vi·ªán lightningcss
      node -e "
        const fs = require('fs');
        // T·∫°o module lightningcss gi·∫£
        const lightningcssPath = './node_modules/lightningcss';
        if (fs.existsSync(lightningcssPath)) {
          if (!fs.existsSync(lightningcssPath + '/node')) {
            fs.mkdirSync(lightningcssPath + '/node', { recursive: true });
          }
          
          // T·∫°o file index.js tr·ªëng trong th∆∞ m·ª•c node
          fs.writeFileSync(lightningcssPath + '/node/index.js', 'module.exports = { transform: () => ({ code: \"\", exports: [], warnings: [] }) };');
          console.log('ƒê√£ v√¥ hi·ªáu h√≥a lightningcss');
        } else {
          console.log('Kh√¥ng t√¨m th·∫•y th∆∞ m·ª•c lightningcss');
        }
      "
      
      # 2. ƒê·∫£m b·∫£o postcss-loader kh√¥ng c·ªë s·ª≠ d·ª•ng lightningcss
      find ./node_modules -name "postcss.config.js" -exec rm -f {} \;
      echo "module.exports = {
        plugins: {
          'postcss-flexbugs-fixes': {},
          'postcss-preset-env': {
            autoprefixer: {
              flexbox: 'no-2009',
            },
            stage: 3,
          },
        },
      };" > postcss.config.js
    
    # T·∫°o custom next.config.js ƒë·ªÉ t·∫Øt ho√†n to√†n lightningcss
    - |
      echo "üìù T·∫°o next.config.mjs (ES Module) t√πy ch·ªânh..."
      
      # Ki·ªÉm tra package.json ƒë·ªÉ x√°c ƒë·ªãnh lo·∫°i module
      IS_ESM=$(node -e "try { const pkg = require('./package.json'); console.log(pkg.type === 'module' ? 'true' : 'false'); } catch (e) { console.log('false'); }")
      
      if [ "$IS_ESM" == "true" ]; then
        echo "D·ª± √°n s·ª≠ d·ª•ng ES Modules, t·∫°o next.config.mjs..."
        cat > next.config.mjs << 'EOL'
        /** @type {import('next').NextConfig} */
        const nextConfig = {
          output: 'export',
          distDir: 'dist',
          experimental: {
            forceSwcTransforms: true,
            useLightningcss: false,
          },
          typescript: {
            ignoreBuildErrors: true,
          },
          eslint: {
            ignoreDuringBuilds: true,
          },
          webpack: (config) => {
            // ƒê·∫£m b·∫£o fallback cho c√°c module Node.js
            config.resolve.fallback = { 
              fs: false, 
              net: false, 
              tls: false 
            };
            
            // L·ªçc ra c√°c loader li√™n quan ƒë·∫øn lightningcss
            const cssRule = config.module.rules.find(rule => rule.oneOf);
            if (cssRule && cssRule.oneOf) {
              cssRule.oneOf.forEach(rule => {
                if (rule.use && Array.isArray(rule.use)) {
                  rule.use = rule.use.filter(u => 
                    !u.loader || !u.loader.includes('lightningcss')
                  );
                }
              });
            }
            
            return config;
          },
        };

        export default nextConfig;
        EOL
        
        # X√≥a next.config.js n·∫øu t·ªìn t·∫°i ƒë·ªÉ tr√°nh xung ƒë·ªôt
        rm -f next.config.js
        cat next.config.mjs
      else
        echo "D·ª± √°n s·ª≠ d·ª•ng CommonJS, t·∫°o next.config.js..."
        cat > next.config.js << 'EOL'
        /** @type {import('next').NextConfig} */
        const nextConfig = {
          output: 'export',
          distDir: 'dist',
          experimental: {
            forceSwcTransforms: true,
            useLightningcss: false,
          },
          typescript: {
            ignoreBuildErrors: true,
          },
          eslint: {
            ignoreDuringBuilds: true,
          },
          webpack: (config) => {
            // ƒê·∫£m b·∫£o fallback cho c√°c module Node.js
            config.resolve.fallback = { 
              fs: false, 
              net: false, 
              tls: false 
            };
            
            // L·ªçc ra c√°c loader li√™n quan ƒë·∫øn lightningcss
            const cssRule = config.module.rules.find(rule => rule.oneOf);
            if (cssRule && cssRule.oneOf) {
              cssRule.oneOf.forEach(rule => {
                if (rule.use && Array.isArray(rule.use)) {
                  rule.use = rule.use.filter(u => 
                    !u.loader || !u.loader.includes('lightningcss')
                  );
                }
              });
            }
            
            return config;
          },
        };

        module.exports = nextConfig;
        EOL
        
        cat next.config.js
      fi
    
    # Build ·ª©ng d·ª•ng v·ªõi c√°c bi·∫øn m√¥i tr∆∞·ªùng ƒë·∫∑c bi·ªát
    - |
      echo "üèóÔ∏è Building application..."
      NEXT_DISABLE_LIGHTNINGCSS=1 \
      NEXT_TELEMETRY_DISABLED=1 \
      NODE_ENV=production \
      NODE_OPTIONS="--max-old-space-size=4096" \
      npm run build
    
    # T·∫°o file zip
    - |
      if [ -d "dist" ]; then
        echo "üì¶ ƒê√≥ng g√≥i th∆∞ m·ª•c dist..."
        cd dist
        zip -r ../deploy.zip .
        cd ..
      else
        echo "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y th∆∞ m·ª•c dist! Ki·ªÉm tra output..."
        ls -la
        exit 1
      fi
  artifacts:
    paths:
      - deploy.zip
  only:
    - staging

deploy:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  tags:
    - trainer
  script:
    - echo "üåê Starting deployment to AWS Amplify..."
    
    # C·∫•u h√¨nh AWS
    - aws configure set aws_access_key_id "$AWS_ACCESS_KEY_ID"
    - aws configure set aws_secret_access_key "$AWS_SECRET_ACCESS_KEY"
    - aws configure set region "$STAGING_AWS_REGION"
    
    # Ki·ªÉm tra x√°c th·ª±c
    - aws sts get-caller-identity
    
    # Deploy l√™n Amplify
    - aws amplify start-deployment --app-id "$STAGING_AMPLIFY_APP_ID" --branch-name "$STAGING_BRANCH" --zip-file fileb://deploy.zip
    
    # Ki·ªÉm tra tr·∫°ng th√°i
    - sleep 5
    - aws amplify list-jobs --app-id "$STAGING_AMPLIFY_APP_ID" --branch-name "$STAGING_BRANCH" --max-results 1
  only:
    - staging
  dependencies:
    - build