stages:
  - build
  - deploy

build:
  stage: build
  image: node:20-bullseye
  tags:
    - trainer
  script:
    - echo "ğŸš€ Starting build process..."
    - apt-get update -qq && apt-get install -y -qq zip build-essential python3

    # Cáº¥u hÃ¬nh mÃ´i trÆ°á»ng Ä‘á»ƒ vÃ´ hiá»‡u hÃ³a LightningCSS
    - export NEXT_DISABLE_LIGHTNINGCSS=1
    - export NODE_OPTIONS="--no-experimental-fetch"

    echo "ğŸ“¦ Installing dependencies..."
    # CÃ i Ä‘áº·t dependencies vÃ  Ä‘áº£m báº£o khÃ´ng cÃ i LightningCSS
    - npm ci --legacy-peer-deps --no-optional
    - npm remove lightningcss || true

    echo "ğŸ”§ Verifying environment..."
    # Kiá»ƒm tra xem LightningCSS Ä‘Ã£ bá»‹ gá»¡ chÆ°a
    - if [ -d "node_modules/lightningcss" ]; then 
        echo "âš ï¸ Warning: LightningCSS still exists! Forcing removal..."; 
        rm -rf node_modules/lightningcss*;
      fi

    - echo "$STAGING_ENV" > .env
    - cat .env

    echo "ğŸ—ï¸ Building application..."
    # Build vá»›i Next.js vÃ  Ä‘áº£m báº£o clean cache
    - rm -rf .next
    - npm run build

    echo "ğŸ“‚ Creating deployment package..."
    - cd dist
    - zip -r ../deploy.zip .
    - cd ..
    - echo "âœ… Build completed successfully!"
  artifacts:
    paths:
      - deploy.zip
  only:
    - staging

deploy:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  tags:
    - trainer
  script:
    - echo "ğŸŒ Starting deployment to AWS Amplify..."
    - echo "ğŸ” Checking environment variables..."
    - |
      if [ -z "$AWS_ACCESS_KEY_ID" ]; then
        echo "âŒ ERROR: AWS_ACCESS_KEY_ID is not set!"
        exit 1
      fi
      if [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
        echo "âŒ ERROR: AWS_SECRET_ACCESS_KEY is not set!"
        exit 1
      fi
      if [ -z "$STAGING_AWS_REGION" ]; then
        echo "âŒ ERROR: STAGING_AWS_REGION is not set!"
        exit 1
      fi
      if [ -z "$STAGING_AMPLIFY_APP_ID" ]; then
        echo "âŒ ERROR: STAGING_AMPLIFY_APP_ID is not set!"
        exit 1
      fi
      if [ -z "$STAGING_BRANCH" ]; then
        echo "âŒ ERROR: STAGING_BRANCH is not set!"
        exit 1
      fi
    - echo "ğŸ”‘ Configuring AWS credentials..."
    - aws configure set aws_access_key_id "$AWS_ACCESS_KEY_ID"
    - aws configure set aws_secret_access_key "$AWS_SECRET_ACCESS_KEY"
    - echo "âš™ï¸ Configuring AWS region to $STAGING_AWS_REGION..."
    - aws configure set region "$STAGING_AWS_REGION"
    - echo "ğŸ” Verifying AWS authentication..."
    - aws sts get-caller-identity
    - echo "ğŸ“‹ Checking deployment file..."
    - ls -la deploy.zip
    - echo "ğŸ“¤ Deploying application to Amplify..."
    - aws amplify start-deployment --app-id "$STAGING_AMPLIFY_APP_ID" --branch-name "$STAGING_BRANCH" --zip-file fileb://deploy.zip
    - echo "ğŸ” Checking deployment status..."
    - sleep 5
    - aws amplify list-jobs --app-id "$STAGING_AMPLIFY_APP_ID" --branch-name "$STAGING_BRANCH" --max-results 1
    - echo "ğŸ‰ Deployment process completed successfully!"
  only:
    - staging
  dependencies:
    - build
