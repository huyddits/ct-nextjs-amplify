stages:
  - build
  - deploy

build:
  stage: build
  image: node:20
  tags:
    - trainer
  script:
    - echo "ğŸš€ Starting build process for application..."
    - echo "ğŸ”§ Installing required tools..."
    - apt-get update -qq && apt-get install -y -qq zip
    - echo "ğŸ“¦ Installing dependencies with npm ci..."
    - npm ci
    - echo "ğŸ”¨ Building application..."
    - npm run build
    - echo "ğŸ“‚ Creating deployment package..."
    - cd dist
    - zip -r ../deploy.zip .
    - cd ..
    - echo "âœ… Build completed successfully! Deployment package created."
  artifacts:
    paths:
      - deploy.zip
  only:
    - staging

deploy:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  tags:
    - trainer
  script:
    - echo "ğŸŒ Starting deployment to AWS Amplify..."
    - echo "ğŸ”‘ Configuring AWS credentials..."
    - aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
    - aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
    - echo "âš™ï¸ Configuring AWS region to ap-southeast-1..."
    - aws configure set region ap-southeast-1
    - echo "ğŸ” Verifying AWS authentication..."
    - aws sts get-caller-identity
    - echo "ğŸ“‹ Checking deployment file..."
    - ls -la deploy.zip
    - echo "ğŸ“¤ Deploying application to Amplify..."
    - aws amplify start-deployment --app-id $STAGING_AMPLIFY_APP_ID --branch-name staging --zip-file fileb://deploy.zip
    - echo "ğŸ” Checking deployment status..."
    - sleep 5
    - aws amplify list-jobs --app-id $STAGING_AMPLIFY_APP_ID --branch-name staging --max-results 1
    - echo "ğŸ‰ Deployment process completed successfully!"
  only:
    - staging
  dependencies:
    - build